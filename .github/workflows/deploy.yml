name: Deploy to Server

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Deploy to server via SSH
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USERNAME }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: ${{ secrets.SERVER_PORT }}
        timeout: 120s
        script: |
          cd /home/frontend/over101/game_frontend
          
          # Git pull 실패 시 배포 중단
          if ! git pull origin main; then
            echo "Git pull failed"
            exit 1
          fi
          
          # 의존성 설치 실패 시 배포 중단
          if ! npm ci; then
            echo "npm ci failed"
            exit 1
          fi
          
          # 빌드 실패 시 배포 중단
          if ! npm run build; then
            echo "Build failed"
            exit 1
          fi
          
          # PM2 프로세스 관리
          pm2 delete game-frontend 2>/dev/null || echo "No existing process"
          
          # serve가 설치되어 있는지 확인
          if ! command -v serve &> /dev/null; then
            npm install -g serve
          fi
          
          pm2 start serve --name "game-frontend" -- -s dist -l 5173
          pm2 save
          
          echo "Deployment completed successfully at $(date)" >> deployment.log